import ReactDOM from 'react-dom';
import React, { useState, useLayoutEffect } from 'react';
import type { ReactElement, ReactNode, Ref } from 'react';
import { Trans } from '@lingui/react/macro';
import { useFloating, computePosition, offset } from '@floating-ui/react';
import type { HumanBodyData } from './weapons-accuracy';

type Props = {
  ref?: React.Ref<SVGPathElement>;
  width: number;
  data: HumanBodyData;
};

function Path({ ref, ...props }: React.SVGProps<SVGPathElement>) {
  return <path ref={ref} className="fill-gray-800 transition-opacity duration-500" {...props} />;
}

type BodyTooltipProps = {
  children: ReactElement<{ ref: Ref<HTMLElement> }>;
  content: ReactNode;
};

function BodyTooltip({ children, content }: BodyTooltipProps) {
  const [isVisible, setIsVisible] = useState(false);
  const { strategy, refs } = useFloating();

  useLayoutEffect(() => {
    const path = refs.reference.current as SVGPathElement | null;
    const floatingRef = refs.floating.current;
    if (path === null || floatingRef === null) {
      return;
    }

    const onMouseMove = async ({ clientX, clientY }: MouseEvent) => {
      const virtualElement = {
        getBoundingClientRect() {
          return {
            width: floatingRef.clientWidth,
            height: floatingRef.clientHeight,
            x: clientX,
            y: clientY,
            left: clientX,
            right: clientX,
            top: clientY,
            bottom: clientY,
          };
        },
      };

      const { x, y } = await computePosition(virtualElement, floatingRef, {
        middleware: [offset(-80)],
      });
      Object.assign(floatingRef.style, {
        top: `${y}px`,
        left: `${x - floatingRef.clientWidth / 2}px`,
      });
    };

    const onMouseEnter = () => {
      setIsVisible(true);
    };
    const onMouseLeave = () => {
      setIsVisible(false);
    };

    path.addEventListener('mouseenter', onMouseEnter);
    path.addEventListener('mouseleave', onMouseLeave);
    path.addEventListener('mousemove', onMouseMove);

    return () => {
      path.removeEventListener('mouseenter', onMouseEnter);
      path.removeEventListener('mouseleave', onMouseLeave);
      path.removeEventListener('mousemove', onMouseMove);
    };
  }, [refs, isVisible]);

  return (
    <>
      {React.cloneElement(children, { ref: refs.setReference })}
      {/* Render the tooltip outside of the svg because a div inside a svg is invalid and so would not appears */}
      {ReactDOM.createPortal(
        <div
          ref={refs.setFloating}
          className="bg-gray-100 border border-gray-400 p-8 rounded-8 transition-opacity duration-300 z-10 pointer-events-none"
          style={{
            position: strategy,
            opacity: isVisible ? 1 : 0,
          }}
        >
          {content}
        </div>,
        document.body,
      )}
    </>
  );
}

export function Body({ width, data }: Props) {
  let maxAccuracy = 1;
  Object.values(data).map((value) => {
    if (value.accuracy > maxAccuracy) {
      maxAccuracy = value.accuracy;
    }
  });

  const headPercentage = data.head.accuracy;
  const headOpacity = headPercentage / maxAccuracy;
  const chestPercentage = data.chest.accuracy;
  const chestOpacity = chestPercentage / maxAccuracy;
  const stomachPercentage = data.stomach.accuracy;
  const stomachOpacity = stomachPercentage / maxAccuracy;
  const rightArmPercentage = data.rightArm.accuracy;
  const rightArmOpacity = rightArmPercentage / maxAccuracy;
  const leftArmPercentage = data.leftArm.accuracy;
  const leftArmOpacity = leftArmPercentage / maxAccuracy;
  const rightLegPercentage = data.rightLeg.accuracy;
  const rightLegOpacity = rightLegPercentage / maxAccuracy;
  const leftLegPercentage = data.leftLeg.accuracy;
  const leftLegOpacity = leftLegPercentage / maxAccuracy;

  return (
    <svg
      x="0px"
      y="0px"
      height={400}
      viewBox="0 0 604.502 1628.762"
      enableBackground="new 0 0 604.502 1628.762"
      width={width}
    >
      <path
        className="fill-gray-50 stroke-gray-800 stroke-1"
        d="M307.71,934.044c-2.887-37.612,3.116-111.464-6.141-106.729c0,0-1.513,6.585-1.773,8.642  c-1.752,13.994-0.121,74.406-2.134,96.522c0,0-7.163,57.876-11.151,74.107c-3.988,16.228-11.166,115.227-19.144,139.574  c-7.976,24.345-16.75,56.8-8.774,81.958c7.976,25.157,16.752,67.352,8.774,105.492c-7.976,38.14-16.75,91.288-11.964,118.069  c3.521,19.706,4.786,38.546,7.978,42.603c3.188,4.057,0,12.169,0,22.721c0,10.547,1.594,33.271-1.995,41.793  c0,6.082,5.183,22.719,2.394,30.427c-2.793,7.711,0,12.174-3.591,15.417c-3.589,3.247-9.572,11.77-22.733,8.525  c-7.978-2.438-8.375-8.525-7.178-9.742c1.195-1.216-4.389-0.402-4.389-0.402c-2.78,5.181-12.76,6.868-17.548-0.406  c-0.796-1.218-3.587,4.461-9.969,3.243s-3.589-4.055-3.589-4.055s-8.377,0.404-10.37-4.463c-0.399,1.216-4.387,2.839-7.579-0.406  c-3.19-3.245-2.791-13.793-1.594-19.07c1.195-5.277,6.796-14.401,8.774-17.854c2.791-4.867,13.161-23.533,12.762-28.806  c-0.248-3.263,0.796-27.998,3.19-34.081c2.394-6.089,2.793-13.391,2.793-21.505c0-8.116,1.995-53.965-13.959-110.363  c-15.954-56.396-23.531-83.984-23.928-122.938c-0.399-38.952,17.147-62.483,6.777-121.312  c-10.368-58.836-14.755-97.785-15.952-101.439c-1.197-3.647-7.675-87.088-7.675-87.088c-0.914-90.865,2.12-75.593,3.35-108.574  c2.353-63.252,1.051-52.022,10.05-88.612c1.577-12.158,2.454-23.04,4.031-35.203c0.657-5.071,2.01-11.418,2.669-16.489  c9.196-31.653,9.142-25.304,5.191-54.251c-2.61-19.17,0.658-16.691,2.614-36.464c0.344-3.505,3.794-65.532-2.78-99.005  c-4.466-13.066-8.932-26.134-13.4-39.197h-0.557c0.201,32.151-11.049,55.538-16.752,82.933c-1.867,13.001-2.392,23.885-4.297,36.877  c-0.585,4.014-1.713,6.857-2.315,10.995c-2.596,17.861,2.82,24.968-3.437,57.216c-7.242,37.317-22.927,69.907-30.15,107.358  c-1.197,6.198-0.553,12.864-0.316,18.911c0.585,4.031,1.615,6.33,2.475,10.552c1.195,5.861,1.78,13.168,2.863,18.818  c1.334,6.942,1.438,15.31,1.664,23.435c0.207,7.346,1.037,12.54,0.288,21.87c-0.218,2.72-0.033,36.328-3.134,48.688  c-1.434,5.7-4.692,5.273-6.077,4.279c-5.716-7.654-0.615-25.119-6.28-43.599c-0.559,0.38-0.559,0.046-1.118,0.425  c0.084,4.047-0.667,9.273-0.179,15.482c0.779,9.977,0.378,14.142,0.07,18.034c-0.832,10.572-1.344,19.719-3.924,25.218  c-1.395,2.974-5.2,5.59-8.669,1.478c-1.937-3.302-2.208-8.173-2.411-15.058c-0.878-30.054-0.969-20.294-1.334-26.969  c-0.388-7.183-0.61-12.768-0.61-12.768c-0.89-0.236-1.494-0.354-2.345-0.022c-2.167,19.698-0.178,15.719-2.96,39.445  c-0.491,4.187-0.139,12.028-1.225,17.079c-2.229,10.363-11.671,9.05-12.444,1.027c-0.265-2.74-0.886-5.687-1.238-8.086  c-0.38-2.592-0.164-6.26-0.254-8.989c-0.139-4.209-0.565-7.888-0.888-12.069c-0.373-4.839,2.084-17.895,0.023-27.551  c-0.026,0-1.142,0-1.116,0c-0.734,4.359-2.245,10.954-3.969,19.445c-0.265,1.309-0.399,3.632-0.681,4.975  c-1.549,7.394-1.393,11.575-2.166,16.148c-1.214,7.224,0.053,8.318-2.505,13.124c-2.791,5.249-7.135,2.857-8.296,0.08  c-1.801-4.311-2.814-11.342-2.795-19.975c0.037-15.995,2.716-19.356,2.825-40.619c0.023-4.404,0.267-8.277-0.282-12.349v2.129  c-2.435,4.109-3.373,8.129-7.816,10.222c-2.213,0.79-4.001,1.246-5.663,0.365c-1.624-0.853-2.718-0.523-2.119-3.736  c0.461-2.47,1.59-5.861,2.014-8.907c0.638-4.582,0.555-8.698,1.641-13.506c0.632-2.789,2.368-6.204,3.203-8.885  c1.366-4.384,1.958-10.449,3.156-12.473c0.903-1.533,3.004-3.975,4.31-5.698c0.346-0.457,8.944-13.182,12.286-17.574  c3.356-4.409,5.699-8.14,5.699-8.14c0.051-11.746,3.059-18.778,2.08-30.076c-1.692-19.557-0.495,1.76-2.339-121.232  c4.78-68.261,11.045-49.621,17.136-111.518c4.058-41.052,4.798-56.274,7.364-64.797c2.452-8.147,6.34-29.092,5.657-43.675  c-0.459-9.801-0.45-14.221-1.543-20.477c-2.05-11.754-1.431-42.739,11.725-69.299c11.477-23.175,27.318-34.048,49.629-43.289  c15.531-6.434,14.433-2.79,42.978-18.213c17.074-9.227,57.814-33.258,65.621-50.863c0.124-16.319-0.366-14.443,0.009-29.778  c0,0-3.213-13.298-4.53-22.591c-6.854-0.074-10.769-6.449-13.127-14.318c-2.094-6.98-1.877-19.262-1.918-20.898  c-0.163-6.367-0.441-12.45,4.995-14.77c1.445-0.341,1.701-0.376,2.351-0.208c0.836,0.213,1.278,1.131,2.115,1.344  c-1.056-33.236,4.238-59.246,25.686-73.844c38.147-25.962,84.194-4.385,96.595,31.244c4.15,11.926,4.212,28.343,2.791,42.601h0.557  c1.212-1.02,1.445-1.628,3.877-1.237c4.303,1.889,5.591,6.919,5.712,15.964c0.177,13.445-0.6,22.432-9.367,31.903  c-2.189,2.366-4.282,2.09-7.477,3.358c-0.207,4.645-2.703,18.616-2.703,18.616s-1.703,28.168-0.651,31.938  c4.364,15.563,55.746,47.859,85.792,61.08c17.748,7.814,48.444,11.768,69.031,44.574c13.863,22.079,19.151,53.497,15.704,74.476  c-1.369,8.304-2.896,28.95-0.455,42.944c10.918,54.033,5.22,16.283,12.421,88.953c3.703,37.295,4.626,32.485,12.068,67.063  c0.877,4.079,0.794,6.836,1.346,12.065c1.663,15.866,5.62,30.424,2.492,104.929c-2.799,66.377-3.96,53.491-0.943,68.354  c1.208,5.992-3.063,8.431,14.057,30.796c1.5,1.958,3.088,4.873,4.581,6.495c1.694,1.845,3.269,2.407,4.457,4.93  c1.314,2.802,0.723,5.179,1.38,8.273c0.807,3.74,1.647,6.727,4.105,12.349c1.013,2.327-0.075,8.781,0.653,13.461  c0.41,2.637,1.961,5.16,2.388,7.739c0.002,0.022,0.939,1.3,0.762,2.483c-0.256,1.687-2.004,3.38-5.381,2.653  c-6.446-1.04-7.101-6.232-10.611-10.035c0.08,5.339-0.595,7.281,1.099,29.728c0.427,5.661,3.893,30.336-1.199,40.461  c-1.756,3.495-5.721,2.996-7.803,0.51c-5.565-6.642-0.373-10.685-8.925-51.36c-1.116-5.271-2.349-0.61-2.349-0.61  c-0.16,25.464,1.666,13.068-0.25,31.836c-0.942,9.126-0.375,27.282-5.445,28.639c-4.658,1.253-7.366-2.318-8.181-5.416  c-2.122-8.108-1.956-18.062-2.014-19.063c-0.154-2.729-1.026-9.119-1.135-11.913c-0.365-9.214,0.497-12.819-1.302-26.917  c-0.143-1.174-1.462-1.35-1.462-1.35c-1.961,1.819-0.851,8.454-1.186,11.551c-3.15,28.922,0.442,32.063-4.351,43.031  c-1.628,3.721-6.48,3.881-8.433,0.491c-1.442-2.512-1.526-5.726-1.705-6.352c-1.756-6.089-1.334-12.805-1.863-18.569  c-0.354-3.81-0.926-4.884-0.856-7.958c0.233-10.437,2.309-16.964,0.412-27.651c-0.373-0.187-0.747-0.378-1.118-0.564  c-0.745,1.157-0.459,2.19-0.832,3.716c-1.212,4.928-1.404,12.154-2.204,17.859c-1.259,9.017,0.911,20.359-4.784,22.732  c-2.791-0.191-2.603-0.38-4.274-2.084c-5.376-13.557-1.805-31.088-3.117-47.522c-1.586-19.77-0.064-18.681,0.35-25.185  c1.917-31.072,0.966-16.394,3.205-32.181c2.262-15.944,3.054-13.863,4.133-21.228c2.059-14.053-0.666-20.851-4.999-37.704  c-0.491-1.921-1.163-3.497-1.622-5.483c-2.089-8.967-5.855-19.003-8.234-27.605c-19.318-69.827-14.488-54.078-17.153-72.648  c-1.286-8.943-1.133-5.494-0.113-35.667c-0.809-5.598-2.364-10.439-3.177-16.035c-1.797-12.391-2.844-25.539-4.639-37.927  c-5.657-26.218-15.956-48.792-16.193-80.094c-0.369,0.189-0.743,0.378-1.116,0.569c-2.808,11.112-8.142,23.815-12.783,35.175  c-2.405,5.894-0.418,6.326-2.522,15.378c-2.886,12.424-4.145,63.823-0.885,88.047c0.927,6.952,1.197,1.809,2.793,20.448  c0.284,3.354-0.164,5.8-0.448,9.638c-0.233,3.137-0.224,7.706-0.638,10.272c-1.468,9.087-3.239,15.532-1.15,24.966  c2.02,9.109,2.677,4.255,8.751,34.942c0.994,5.012,0.751,7.619,1.466,13.365c0.565,4.546,2.078,12.258,2.836,16.265  c0.745,3.916,1.063,8.954,1.788,12.814c1.568,8.348,8.083,29.891,8.46,62.064c0.704,59.53,4.476,55.504,4.024,102.244  c-0.614,56.92-8.584,147.539-14.226,174.122c-7.577,35.704-12.762,81.961-9.967,90.885c2.787,8.926,12.363,79.119,6.775,111.58  c-5.582,32.455-34.296,139.976-33.897,161.887c0.397,21.911-5.919,41.448,0.397,55.584c3.99,8.926,1.199,27.188,2.793,32.459  c1.596,5.275,3.589,20.288,9.173,24.751c5.584,4.465,15.154,27.184,13.161,34.489c-1.995,7.302-5.185,12.983-10.37,10.956  c-4.385,4.869-9.971,3.651-11.166,3.245c-1.197-0.406-4.387,8.926-13.959,1.624c-2.392,3.649-5.582,6.488-12.365,3.649  c-6.779-2.839-4.784-3.649-4.784-3.649l-5.185,0.81c0,0,0.796,10.55-8.776,10.55c-9.57,0-23.529-6.493-22.731-17.04  c0.796-10.552-0.798-24.753,3.988-39.358c-4.786-10.144-5.185-26.372-2.791-34.085c2.392-7.704,0-17.85-0.401-23.123  c-0.399-5.277,7.579-37.33,7.579-46.254c0-8.93,0.798-90.483-4.786-102.654c-5.584-12.169-12.762-60.049-4.387-93.316  c0,0,10.11-48.282,10.37-60.455c0.397-18.666-20.341-75.874-20.341-98.593c0-22.723-13.56-109.147-15.154-115.64  C315.225,977.372,307.71,934.044,307.71,934.044"
      />
      <BodyTooltip content={<Trans context="Tooltip">Head {headPercentage}% of hits</Trans>}>
        <Path
          opacity={headOpacity}
          d="m 302.54983,17.059772 c -27.66318,0.811694 -47.85763,18.163666 -54.66091,41.082715 l -0.34815,62.668543 9.40028,73.11331 93.3065,-0.69632 7.65949,-75.55041 0.69632,-61.275916 C 351.08881,38.549506 330.89971,19.122686 302.54983,17.059772 Z"
        />
      </BodyTooltip>
      <BodyTooltip content={<Trans context="Tooltip">Chest {chestPercentage}% of hits</Trans>}>
        <Path
          opacity={chestOpacity}
          d="m 236.3379,242.24634 c -39.38965,1.96949 -76.80982,29.54224 -90.10383,41.35914 8.86267,53.34015 5.41608,107.66504 26.58802,160.02045 l 260.95642,1.47711 c 20.51544,-55.14551 17.88947,-108.32154 27.57276,-165.43653 -24.78266,-12.80164 -48.0882,-31.01935 -83.21064,-36.9278 z"
        />
      </BodyTooltip>
      <BodyTooltip content={<Trans context="Tooltip">Right arm {rightArmPercentage} % of hits</Trans>}>
        <Path
          opacity={rightArmOpacity}
          d="m 111.27576,303.3003 c 23.96203,44.96985 41.03089,91.90918 42.34387,137.86377 l -23.63378,140.818 c -0.6565,20.67957 1.64123,39.38965 -5.90846,60.06922 -3.61071,37.42017 -20.97729,80.80981 -27.542232,118.22998 7.549682,31.83996 9.160402,50.81727 7.847412,82.65723 l -36.435425,5.90844 C 50.221803,841.29726 35.231,840.521 32.496461,820.28945 39.389649,793.04494 47.176027,791.49525 58.00818,777.05238 L 58.853732,661.7425 c 0.167152,-28.14434 0.516529,-52.11633 5.154448,-77.79094 L 89.611453,388.97279 c -3.282471,-7.54968 -0.656495,-16.08411 -3.938966,-23.63379 5.5802,-28.5575 11.160406,-48.25232 25.603273,-62.0387 z"
        />
      </BodyTooltip>
      <BodyTooltip content={<Trans context="Tooltip">Stomach {stomachPercentage}% of hits</Trans>}>
        <Path
          opacity={stomachOpacity}
          d="m 175.28394,458.88941 c 4.92371,13.45813 10.83215,30.85523 12.80164,44.31336 -0.32825,91.90918 -11.48865,189.72681 -12.80164,272.77332 13.45813,29.87049 239.62036,35.12243 249.13953,0 -1.31299,-93.87866 -3.61071,-187.75733 -3.93896,-281.63599 4.26721,-14.77112 10.50391,-23.63379 15.75586,-35.45069 z"
        />
      </BodyTooltip>
      <BodyTooltip content={<Trans context="Tooltip">Left arm {leftArmPercentage}% of hits</Trans>}>
        <Path
          opacity={leftArmOpacity}
          d="m 495.32484,304.28504 c 21.00782,12.47339 24.29028,41.68738 24.61853,64.00818 v 73.85559 c 9.51916,36.10718 15.09937,88.95496 19.69483,134.90955 7.22144,14.44287 4.59545,29.87049 6.89318,44.31336 5.5802,48.58057 -0.65649,96.17639 -0.98474,144.75696 8.20618,15.42761 16.41235,30.85523 24.61853,46.28284 l 0.98475,21.66431 c -4.59546,4.59546 -2.13792,9.70917 -13.78638,13.78637 -12.14514,-0.32825 -24.29029,-0.65649 -36.43543,-0.98474 -5.90845,-3.93896 -17.72534,-11.81689 -17.72534,-11.81689 v -31.51172 c 2.62598,-16.41235 5.25195,-30.85523 8.86267,-46.28284 -11.81689,-39.38965 -21.66431,-78.7793 -33.4812,-118.16895 -0.65649,-13.45813 -1.31299,-26.91626 -1.96948,-40.37439 -1.64124,-25.27502 -5.28247,-50.55005 -6.92371,-75.82507 -11.1604,-27.57275 -22.3208,-52.22181 -15.75586,-78.80982 5.25195,-56.13025 10.53443,-117.15369 41.38965,-139.80274 z"
        />
      </BodyTooltip>
      <BodyTooltip content={<Trans context="Tooltip">Right leg {rightLegPercentage}% of hits</Trans>}>
        <Path
          opacity={rightLegOpacity}
          d="m 157.49756,804.53359 c 45.29809,3.28247 88.68775,12.47339 131.03162,18.71008 v 107.3368 c -4.26722,55.47374 -12.41235,110.94753 -20.61853,166.42123 -5.25195,35.4507 -14.50391,70.9014 -19.75586,106.3521 l 15.84741,82.9014 c -1.02534,48.0832 -9.62128,93.2513 -16.83215,141.6196 l 6.89319,48.2523 c 1.31299,18.7101 2.62597,37.4202 3.93896,56.1303 -1.76604,16.251 3.3838,26.5386 1.96949,53.0539 -19.638,13.6179 -61.18869,18.4917 -74.7793,-3.9084 -7.82457,-12.8965 9.78637,-26.1682 16.67956,-42.2523 0.98474,-9.5192 1.96949,-19.0383 2.95423,-28.5575 l 5.90844,-60.0693 c -5.25195,-33.8094 -9.54968,-67.6189 -17.75585,-101.4283 -12.14515,-26.2598 -20.35132,-58.5195 -21.66431,-84.7793 l 2,-40.2523 8.86267,-94.5657 c -12.14514,-49.2371 -17.42761,-74.7793 -21.69483,-120.0774 -7.54969,-29.87048 -3.25195,-59.802 -5.87793,-87.703 z"
        />
      </BodyTooltip>
      <BodyTooltip content={<Trans context="Tooltip">Left leg {leftLegPercentage}% of hits</Trans>}>
        <Path
          opacity={leftLegOpacity}
          d="m 314.13245,824.16738 c 45.71772,-8.44968 77.63892,-9.31424 130.97059,-13.75586 12.787,17.0625 6.21923,66.92633 5.90845,100.47412 -0.47272,51.02835 -6.15635,101.91926 -11.8169,152.63486 -3.27494,29.3418 -12.6741,58.1183 -12.80163,87.642 -0.073,16.8974 5.33447,33.3963 6.89318,50.2218 1.8795,20.2883 4.63772,40.7485 2.95423,61.054 -4.21848,50.8813 -25.74406,99.0732 -32.49646,149.6806 -3.34719,25.0863 -5.5373,50.569 -3.90845,75.8251 1.41728,21.9756 5.04231,44.0494 11.84741,64.9929 3.26377,10.0446 18.7988,19.2943 13.72534,28.5575 -11.75375,21.4601 -54.36784,24.8423 -72.87085,8.8322 -11.17321,-9.6679 -1.01681,-29.5382 -1.04577,-44.3134 -0.0347,-17.7186 -0.38409,-35.4847 1.04577,-53.1455 1.12383,-13.8809 5.37929,-27.4428 5.90845,-41.3591 1.33783,-35.1836 -3.80404,-71.7052 -6.95422,-105.3978 -1.9726,-21.0979 -6.89197,-37.1788 -6.86267,-55.9777 0.0532,-34.1167 14.24672,-67.4656 12.77111,-101.5504 -1.27787,-29.5173 -13.85306,-57.4992 -18.61853,-86.6573 -8.51337,-52.0901 -16.67901,-135.99582 -17.75586,-157.34493 -1.65982,-32.90684 -10.92623,-101.31375 -6.89319,-120.41309 z"
        />
      </BodyTooltip>
    </svg>
  );
}
